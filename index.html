<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welfare First — EROAD Customer Onboarding Process</title>
    <!-- 
        Interactive Onboarding Flowchart
        Generated by: Claude (Anthropic)
        Build Date: 2025-10-21
    -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
        }
        
        .node-card {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            min-width: 220px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 3px solid;
            font-size: 15px;
        }
        
        .node-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }
        
        .node-card.selected {
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.4), 0 12px 40px rgba(0, 0, 0, 0.15);
            z-index: 101;
        }
        
        .node-card.audit-critical {
            border-color: #ef4444 !important;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%) !important;
            animation: pulse-critical 2s ease-in-out infinite;
        }
        
        .node-card.audit-high {
            border-color: #f59e0b !important;
            background: linear-gradient(135deg, #fffbeb 0%, #fed7aa 100%) !important;
        }
        
        @keyframes pulse-critical {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }
        
        .edge-line {
            stroke: #cbd5e1;
            stroke-width: 3;
            fill: none;
            transition: all 0.3s ease;
        }
        
        .edge-line:hover {
            stroke: #667eea;
            stroke-width: 4;
        }
        
        .edge-arrow {
            fill: #cbd5e1;
        }
        
        @keyframes dash {
            to { stroke-dashoffset: -20; }
        }
        
        .detail-panel {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const NODES_DATA = [
            {
                id: 'cognitoForm', title: 'Cognito Onboarding Form', category: 'Account/Setup',
                x: 50, y: 50, context: 'EROAD sends customer a Cognito form to collect initial onboarding data including vehicle registrations, physical locations, and escalation contacts',
                inputs: ['Customer details', 'Vehicle regos', 'Locations', 'Escalation contacts'],
                downstream: ['MyEROAD account', 'User uploads', 'Organization creation'],
                owner: 'EROAD Sales', gaps: ['No mandatory timezone field', 'No Welfare First group designation'],
                workarounds: ['Manual follow-up', 'Assume default timezone'],
                ideal: ['Make timezone required', 'Add WF group checkbox', 'Structured escalation priority'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'myeroadAccount', title: 'MyEROAD Account Creation', category: 'Account/Setup',
                x: 50, y: 200, context: 'Sales creates a MyEROAD account for the customer and provides login credentials to Welfare First',
                inputs: ['Cognito responses', 'Customer name'],
                downstream: ['API key generation', 'Group creation', 'Monitoring activation'],
                owner: 'EROAD Sales', gaps: ['No standardized handoff', 'Credentials sent via email (security risk)'],
                workarounds: ['Manual email with username/password'],
                ideal: ['Automated provisioning', 'Secure credential vault', 'Notification webhook'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'apiKeyGeneration', title: 'Partner API Key Generation', category: 'Account/Setup',
                x: 50, y: 350, context: 'Sales generates partner API key using secure vault link (24h expiry) - critical as WF needs partner key type',
                inputs: ['MyEROAD account', 'Secure vault access'],
                downstream: ['API key integration', 'Driver sync', 'Fleet data pull'],
                owner: 'EROAD Sales Ops', gaps: ['Vault link expires in 24h', 'No expiry metadata', 'Key type confusion'],
                workarounds: ['Request resend', 'Internal doc mapping'],
                ideal: ['Extended vault validity', 'Secrets manager integration', 'Auto key rotation'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'enterpriseCreation', title: 'WF Enterprise Creation', category: 'Account/Setup',
                x: 350, y: 50, context: 'Create new Welfare First enterprise (one per customer, ties to single API key) with branding and settings',
                inputs: ['Customer name', 'Branding assets', 'API key'],
                downstream: ['Organization creation', 'API integration', 'Call center enable'],
                owner: 'Welfare First Admin (Sai)', gaps: ['Manual Gethome-safe steps', 'No audit log'],
                workarounds: ['Manual coordination', 'Signup request process'],
                ideal: ['Self-service creation', 'Prefilled template', 'Automated audit log'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'apiKeyIntegration', title: 'API Key Integration', category: 'Data & Integration',
                x: 350, y: 350, context: 'Add partner API key in WF, enable driver sync, validate key format and test connectivity',
                inputs: ['Partner API key', 'WF enterprise'],
                downstream: ['Group selection', 'Vehicle sync', 'Driver sync'],
                owner: 'Welfare First Admin (Sai)', gaps: ['Malformed keys', 'No auto validation', 'Manual tracking'],
                workarounds: ['Ask EROAD to regenerate', 'Internal mapping doc'],
                ideal: ['Auto validation', 'Preflight check', 'Health monitoring dashboard'],
                manual: true, severity: 'LOW'
            },
            {
                id: 'groupSelection', title: 'Fleet Group Selection', category: 'Data & Integration',
                x: 650, y: 350, context: 'Select correct MyEROAD groups - wrong group = missing vehicles in dashboard',
                inputs: ['API connection', 'MyEROAD groups', 'Fleet list'],
                downstream: ['Vehicle-user mapping', 'Monitoring dashboard', 'Alert generation'],
                owner: 'Welfare First Onboarding (Sai)', gaps: ['Wrong group = missing vehicles', 'No preflight % check'],
                workarounds: ['Manual API verification', 'Cross-reference rego list'],
                ideal: ['Preflight % vehicles check', 'Auto-suggest WF group', 'Visual diff tool'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'orgCreation', title: 'Organization Creation', category: 'Account/Setup',
                x: 650, y: 50, context: 'Create Organization(s) with contact, URL segment, timezone - multi-region needs multiple orgs',
                inputs: ['Enterprise', 'Cognito data', 'Customer regions'],
                downstream: ['Team creation', 'User assignment', 'Portal access'],
                owner: 'Welfare First Admin', gaps: ['Timezone mismatches', 'Manual Cognito entry'],
                workarounds: ['Manual entry', 'Multiple orgs per timezone'],
                ideal: ['Auto-suggest from Cognito', 'Require timezone', 'Bulk org creation'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'teamCreation', title: 'Team Creation', category: 'Account/Setup',
                x: 950, y: 50, context: 'Create Teams representing locations/branches with escalation contacts',
                inputs: ['Organization', 'Physical locations', 'Escalation contacts'],
                downstream: ['User assignment', 'Escalation workflow', 'Call center routing'],
                owner: 'Welfare First Admin', gaps: ['Manual process', 'No bulk creation'],
                workarounds: ['Create one by one'],
                ideal: ['Bulk creation from Cognito', 'Template setup', 'Auto-populate'],
                manual: true, severity: 'LOW'
            },
            {
                id: 'userBulkUpload', title: 'User Bulk Upload', category: 'Account/Setup',
                x: 950, y: 200, context: 'Bulk upload users via CSV (max 100/batch) - bottleneck due to email verification',
                inputs: ['Cognito contacts', 'CSV template', 'Team assignments'],
                downstream: ['Email verification', 'Team leader assignment', 'Vehicle mapping'],
                owner: 'Welfare First Admin', gaps: ['Email verification spam', 'No SSO', '100 user limit', 'No timezone/priority fields'],
                workarounds: ['Dummy emails (sai.*@firstsecurity.co.nz)', 'CC Sai', 'Tony\'s bot'],
                ideal: ['SSO provisioning', 'Auto-confirm bot', 'Bypass verification', 'Timezone/priority fields'],
                manual: true, severity: 'HIGH'
            },
            {
                id: 'teamLeaderAssignment', title: 'Team Leader Assignment', category: 'Account/Setup',
                x: 950, y: 350, context: 'Assign team leaders via UI three-dot menu - no explicit priority field',
                inputs: ['Users', 'Teams', 'Escalation hierarchy'],
                downstream: ['Call center escalation', 'Alert routing'],
                owner: 'Welfare First Admin', gaps: ['No escalation ordering field', 'Manual UI clicks'],
                workarounds: ['Name suffixes (Escalation-1, Escalation-2)', 'Manual clicks'],
                ideal: ['Explicit priority fields', 'Bulk assignment', 'Drag-drop ordering'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'vehicleUserMapping', title: 'Vehicle→User Mapping', category: 'Data & Integration',
                x: 1250, y: 200, context: 'CRITICAL: Map vehicles to users - unmapped vehicles won\'t appear as alerts in WF dashboard',
                inputs: ['Vehicle list from API', 'User list', 'Registration numbers'],
                downstream: ['Alert generation', 'Monitoring dashboard', 'Escalation workflow'],
                owner: 'Welfare First Admin', gaps: ['Manual per vehicle', 'Error-prone', 'No progress indicator'],
                workarounds: ['Manual assignment', 'Rego spreadsheet cross-reference'],
                ideal: ['Bulk mapping by rego', 'Progress % indicator', 'Auto-suggest', 'Unmapped warnings'],
                manual: true, severity: 'HIGH'
            },
            {
                id: 'callCenterEnable', title: 'Call Center Enable', category: 'Ops/Monitoring',
                x: 50, y: 550, context: 'Gethome-safe must add enterprise to call center dashboard - Sai cannot do this himself',
                inputs: ['Enterprise setup complete', 'Teams configured'],
                downstream: ['Monitoring workflow', 'Alert handling', 'Operator access'],
                owner: 'Gethome-safe + WF', gaps: ['Team dependency', 'Manual enablement', 'No readiness check'],
                workarounds: ['Manual request to Gethome-safe'],
                ideal: ['Auto-enable after preflight', 'Self-service', 'Readiness validation'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'monitoringWorkflow', title: 'Monitoring Operator Workflow', category: 'Ops/Monitoring',
                x: 350, y: 550, context: 'Operators follow SOP - many skip marking Done reducing auditability',
                inputs: ['Alert events', 'SOP checklist', 'MyEROAD footage'],
                downstream: ['Activity PDF', 'Customer notification', 'Status updates'],
                owner: 'Call Center Ops', gaps: ['Operators skip Done', 'No forced completion', 'No footage indicator'],
                workarounds: ['Read event label first', 'Manual checklist'],
                ideal: ['Embedded SOP with forced completion', 'Timestamped steps', 'Footage indicator'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'activityPdfUpload', title: 'Activity PDF Upload', category: 'Ops/Monitoring',
                x: 650, y: 550, context: 'Operator saves as PDF (Ctrl+P), uploads to WF portal, adds notes, changes status',
                inputs: ['Activity details', 'Follow-up notes'],
                downstream: ['Customer records', 'Audit trail', 'Billing records'],
                owner: 'Call Center Ops', gaps: ['Manual PDF save/upload', 'Inefficient', 'Inconsistent formats'],
                workarounds: ['Ctrl+P', 'Manual upload', 'Manual status change'],
                ideal: ['Auto-generate and store PDF', 'Auto-link to customer', 'One-click workflow'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'monitoringActivation', title: '⚠️ Monitoring Activation Toggle', category: 'Ops/Monitoring',
                x: 950, y: 550, context: 'CRITICAL: Customer controls ON/OFF but WF has ZERO visibility - no API, webhook, or timestamp',
                inputs: ['Customer decision in MyEROAD'],
                downstream: ['Billing records', 'Alert generation', 'Operator workload'],
                owner: 'EROAD + WF', gaps: ['NO API/webhook', 'NO timestamp', 'Billing misalignment', 'Operational blind spot'],
                workarounds: ['None - complete visibility gap'],
                ideal: ['EROAD webhook with timestamp', 'Vehicle list', 'Real-time notification', 'Billing sync'],
                manual: true, severity: 'CRITICAL'
            },
            {
                id: 'offboardingProcess', title: '⚠️ Offboarding Process', category: 'Ops/Monitoring',
                x: 1250, y: 550, context: 'CRITICAL: Manual email process - EROAD not notified, continues billing causing disputes',
                inputs: ['Customer offboard request', 'Vehicle list'],
                downstream: ['Billing adjustments', 'EROAD updates', 'Access revocation'],
                owner: 'WF + EROAD', gaps: ['Manual email', 'EROAD not notified', 'Continues billing', 'Manual reconciliation'],
                workarounds: ['Manual email to WF', 'Manual email to EROAD', 'Excel tracking'],
                ideal: ['Auto notification to EROAD', 'Exact timestamp', 'Auto billing stop', 'Auto reconciliation'],
                manual: true, severity: 'CRITICAL'
            },
            {
                id: 'credentialsManagement', title: 'Credentials Management', category: 'Automation/Tools',
                x: 50, y: 750, context: 'Credentials in Teams doc with common passwords - security risk, no programmatic access',
                inputs: ['Customer credentials', 'API keys', 'Portal logins'],
                downstream: ['All WF operations', 'Portal access', 'API integrations'],
                owner: 'WF / InfoSec', gaps: ['Teams doc storage', 'Security risk', 'No programmatic access', 'Browser extension awaiting approval'],
                workarounds: ['Teams doc', 'Temporary emails', 'Manual copy-paste'],
                ideal: ['Secrets manager (LastPass/vault)', 'RBAC', 'API access', 'Approved extension'],
                manual: true, severity: 'HIGH'
            },
            {
                id: 'excelTracking', title: 'Excel Onboarding Tracker', category: 'Automation/Tools',
                x: 350, y: 750, context: 'Manual Excel tracker - no live updates, out of sync, no automated notifications',
                inputs: ['All onboarding steps', 'Status updates'],
                downstream: ['Progress visibility', 'Stakeholder updates', 'Bottleneck ID'],
                owner: 'WF Product', gaps: ['Manual tracking', 'No live updates', 'Out of sync', 'No notifications'],
                workarounds: ['Manual Excel updates', 'Regular check-ins'],
                ideal: ['Onboarding dashboard', 'Live % completion', 'Auto updates', 'Missing step alerts'],
                manual: true, severity: 'MEDIUM'
            },
            {
                id: 'verificationBot', title: 'Email Verification Bot', category: 'Automation/Tools',
                x: 650, y: 750, context: 'Tony\'s bot auto-confirms verification emails - reduces manual clicking',
                inputs: ['Verification emails', 'Dummy addresses'],
                downstream: ['User activation', 'Faster onboarding'],
                owner: 'Engineering (Tony)', gaps: ['Not fully deployed', 'Requires maintenance'],
                workarounds: ['Manual clicks'],
                ideal: ['Fully automated', 'Integrated workflow', 'Scaled deployment'],
                manual: false, severity: 'LOW'
            },
            {
                id: 'browserExtension', title: 'Browser Portal Extension', category: 'Automation/Tools',
                x: 950, y: 750, context: 'Extension for fast portal switching - awaiting InfoSec approval',
                inputs: ['Portal URLs', 'Stored credentials'],
                downstream: ['Faster workflow', 'Reduced context switching'],
                owner: 'Engineering / InfoSec', gaps: ['Awaiting InfoSec approval', 'Not deployed'],
                workarounds: ['Manual portal login'],
                ideal: ['Approved and deployed', 'Secrets manager integration', 'Single-click access'],
                manual: false, severity: 'LOW'
            },
            {
                id: 'preflightChecks', title: 'Preflight API Checks', category: 'Automation/Tools',
                x: 1250, y: 750, context: 'Automated preflight validation - prevents common setup errors',
                inputs: ['API key', 'Group selection', 'Vehicle count'],
                downstream: ['Quality assurance', 'Error prevention', 'Faster go-live'],
                owner: 'Engineering', gaps: ['Not fully implemented', 'Manual validation still required'],
                workarounds: ['Manual API testing', 'Visual inspection'],
                ideal: ['Full validation suite', 'Count reconciliation', 'Group verification', 'Go/no-go dashboard'],
                manual: false, severity: 'LOW'
            }
        ];

        const EDGES = [
            { from: 'cognitoForm', to: 'myeroadAccount' },
            { from: 'cognitoForm', to: 'orgCreation' },
            { from: 'cognitoForm', to: 'userBulkUpload' },
            { from: 'myeroadAccount', to: 'apiKeyGeneration' },
            { from: 'apiKeyGeneration', to: 'apiKeyIntegration' },
            { from: 'enterpriseCreation', to: 'apiKeyIntegration' },
            { from: 'apiKeyIntegration', to: 'groupSelection' },
            { from: 'groupSelection', to: 'vehicleUserMapping' },
            { from: 'enterpriseCreation', to: 'orgCreation' },
            { from: 'orgCreation', to: 'teamCreation' },
            { from: 'teamCreation', to: 'userBulkUpload' },
            { from: 'userBulkUpload', to: 'teamLeaderAssignment' },
            { from: 'userBulkUpload', to: 'vehicleUserMapping' },
            { from: 'vehicleUserMapping', to: 'monitoringWorkflow' },
            { from: 'enterpriseCreation', to: 'callCenterEnable' },
            { from: 'callCenterEnable', to: 'monitoringWorkflow' },
            { from: 'monitoringWorkflow', to: 'activityPdfUpload' },
            { from: 'myeroadAccount', to: 'monitoringActivation' },
            { from: 'monitoringActivation', to: 'monitoringWorkflow' },
            { from: 'monitoringWorkflow', to: 'offboardingProcess' },
            { from: 'apiKeyGeneration', to: 'credentialsManagement' },
            { from: 'credentialsManagement', to: 'browserExtension' },
            { from: 'userBulkUpload', to: 'verificationBot' },
            { from: 'apiKeyIntegration', to: 'preflightChecks' },
            { from: 'enterpriseCreation', to: 'excelTracking' }
        ];

        const CATEGORIES = {
            'Account/Setup': '#3b82f6',
            'Data & Integration': '#8b5cf6',
            'Ops/Monitoring': '#10b981',
            'Automation/Tools': '#f59e0b'
        };

        function FlowchartApp() {
            const [selectedNode, setSelectedNode] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [auditMode, setAuditMode] = useState(false);
            const [idealState, setIdealState] = useState(false);
            const [zoom, setZoom] = useState(0.65);
            const [pan, setPan] = useState({ x: 50, y: 50 });
            const svgRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

            useEffect(() => {
                const hash = window.location.hash.slice(1);
                if (hash) {
                    const node = NODES_DATA.find(n => n.id === hash);
                    if (node) setSelectedNode(node);
                }
            }, []);

            const handleNodeClick = (node) => {
                setSelectedNode(node);
                window.location.hash = node.id;
            };

            const handleMouseDown = (e) => {
                if (e.target.tagName === 'svg' || e.target.classList.contains('flowchart-container')) {
                    setIsDragging(true);
                    setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
                }
            };

            const handleMouseMove = (e) => {
                if (isDragging) {
                    setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
                }
            };

            const handleMouseUp = () => {
                setIsDragging(false);
            };

            const handleWheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY * -0.001;
                setZoom(z => Math.min(Math.max(0.3, z + delta), 2));
            };

            const fitView = () => {
                setZoom(0.65);
                setPan({ x: 50, y: 50 });
            };

            const jumpToGap = () => {
                const critical = NODES_DATA.find(n => n.severity === 'CRITICAL');
                if (critical) {
                    handleNodeClick(critical);
                    setPan({ x: -critical.x * zoom + 400, y: -critical.y * zoom + 300 });
                }
            };

            const exportCSV = () => {
                const headers = ['node_id', 'title', 'category', 'owner', 'gaps', 'workarounds', 'ideal', 'severity'];
                const rows = NODES_DATA.map(n => [n.id, n.title, n.category, n.owner, n.gaps.join('; '), n.workarounds.join('; '), n.ideal.join('; '), n.severity]);
                const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wf-eroad-nodes.csv';
                a.click();
            };

            const exportAuditCSV = () => {
                const headers = ['node_id', 'title', 'severity', 'gaps', 'recommendations'];
                const rows = NODES_DATA.filter(n => n.gaps.length > 0).map(n => [n.id, n.title, n.severity, n.gaps.join('; '), n.ideal.join('; ')]);
                const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wf-eroad-audit-report.csv';
                a.click();
            };

            const filteredNodes = NODES_DATA.filter(n =>
                !searchTerm || n.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                n.owner.toLowerCase().includes(searchTerm.toLowerCase()) ||
                n.context.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="flex flex-col h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500">
                    {/* Toolbar */}
                    <div className="no-print bg-white shadow-2xl p-4 z-50">
                        <div className="flex items-center justify-between gap-4 flex-wrap">
                            <h1 className="text-2xl font-black bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                                WF — EROAD Onboarding
                            </h1>
                            
                            <input
                                type="text"
                                placeholder="🔍 Search nodes..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none text-base w-80"
                            />
                            
                            <div className="flex gap-2 flex-wrap">
                                <button
                                    onClick={() => setAuditMode(!auditMode)}
                                    className={`px-5 py-2.5 rounded-xl font-bold text-base transition-all ${auditMode ? 'bg-amber-500 text-white shadow-lg scale-105' : 'bg-gray-100 hover:bg-gray-200'}`}
                                >
                                    🔍 Audit Mode
                                </button>
                                
                                <button
                                    onClick={() => setIdealState(!idealState)}
                                    className={`px-5 py-2.5 rounded-xl font-bold text-base transition-all ${idealState ? 'bg-green-500 text-white shadow-lg scale-105' : 'bg-gray-100 hover:bg-gray-200'}`}
                                >
                                    💡 Ideal State
                                </button>
                                
                                <button onClick={jumpToGap} className="px-5 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-base transition-all hover:scale-105 shadow-lg">
                                    🚨 Jump to Gap
                                </button>
                                
                                <button onClick={fitView} className="px-5 py-2.5 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-bold text-base transition-all hover:scale-105 shadow-lg">
                                    ⛶ Fit View
                                </button>
                                
                                <button onClick={() => setZoom(z => Math.min(2, z * 1.2))} className="px-4 py-2.5 bg-gray-700 hover:bg-gray-800 text-white rounded-xl font-bold text-xl">+</button>
                                <button onClick={() => setZoom(z => Math.max(0.3, z * 0.8))} className="px-4 py-2.5 bg-gray-700 hover:bg-gray-800 text-white rounded-xl font-bold text-xl">−</button>
                                
                                <div className="relative group">
                                    <button className="px-5 py-2.5 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold text-base transition-all hover:scale-105 shadow-lg">
                                        📥 Export
                                    </button>
                                                                            <div className="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-2xl border-2 border-gray-100 hidden group-hover:block z-50">
                                            <button onClick={exportCSV} className="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-t-xl font-semibold">📊 Export CSV</button>
                                            <button onClick={exportAuditCSV} className="w-full text-left px-4 py-3 hover:bg-gray-50 font-semibold">📋 Audit Report</button>
                                            <button onClick={() => window.print()} className="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-b-xl font-semibold">🖨️ Print</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Canvas */}
                    <div 
                        className="flex-1 relative overflow-hidden cursor-grab active:cursor-grabbing"
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        onWheel={handleWheel}
                    >
                        <svg ref={svgRef} className="w-full h-full" style={{ background: 'white' }}>
                            <g transform={`translate(${pan.x}, ${pan.y}) scale(${zoom})`}>
                                {/* Category Backgrounds */}
                                <rect x="0" y="0" width="1500" height="250" fill="#eff6ff" opacity="0.3" rx="20" />
                                <text x="20" y="35" fontSize="24" fontWeight="800" fill="#3b82f6">Account / Setup</text>
                                
                                <rect x="0" y="280" width="1500" height="250" fill="#f5f3ff" opacity="0.3" rx="20" />
                                <text x="20" y="315" fontSize="24" fontWeight="800" fill="#8b5cf6">Data & Integration</text>
                                
                                <rect x="0" y="540" width="1500" height="250" fill="#f0fdf4" opacity="0.3" rx="20" />
                                <text x="20" y="575" fontSize="24" fontWeight="800" fill="#10b981">Ops / Monitoring</text>
                                
                                <rect x="0" y="730" width="1500" height="180" fill="#fffbeb" opacity="0.3" rx="20" />
                                <text x="20" y="765" fontSize="24" fontWeight="800" fill="#f59e0b">Automation / Tools</text>

                                {/* Edges */}
                                {EDGES.map((edge, i) => {
                                    const from = NODES_DATA.find(n => n.id === edge.from);
                                    const to = NODES_DATA.find(n => n.id === edge.to);
                                    if (!from || !to) return null;
                                    
                                    const x1 = from.x + 110;
                                    const y1 = from.y + 50;
                                    const x2 = to.x + 110;
                                    const y2 = to.y + 50;
                                    
                                    const dx = x2 - x1;
                                    const dy = y2 - y1;
                                    const len = Math.sqrt(dx * dx + dy * dy);
                                    const arrowSize = 12;
                                    const endX = x2 - (dx / len) * arrowSize;
                                    const endY = y2 - (dy / len) * arrowSize;
                                    
                                    return (
                                        <g key={i}>
                                            <line
                                                className="edge-line"
                                                x1={x1}
                                                y1={y1}
                                                x2={endX}
                                                y2={endY}
                                            />
                                            <polygon
                                                className="edge-arrow"
                                                points={`${x2},${y2} ${x2 - arrowSize * Math.cos(Math.atan2(dy, dx) - Math.PI / 6)},${y2 - arrowSize * Math.sin(Math.atan2(dy, dx) - Math.PI / 6)} ${x2 - arrowSize * Math.cos(Math.atan2(dy, dx) + Math.PI / 6)},${y2 - arrowSize * Math.sin(Math.atan2(dy, dx) + Math.PI / 6)}`}
                                            />
                                        </g>
                                    );
                                })}

                                {/* Nodes */}
                                {filteredNodes.map(node => {
                                    const color = CATEGORIES[node.category];
                                    let className = 'node-card';
                                    if (selectedNode?.id === node.id) className += ' selected';
                                    if (auditMode && node.severity === 'CRITICAL') className += ' audit-critical';
                                    else if (auditMode && node.severity === 'HIGH') className += ' audit-high';
                                    
                                    return (
                                        <foreignObject
                                            key={node.id}
                                            x={node.x}
                                            y={node.y}
                                            width="220"
                                            height="120"
                                            onClick={() => handleNodeClick(node)}
                                        >
                                            <div className={className} style={{ borderColor: color }}>
                                                <div className="flex items-start justify-between mb-2">
                                                    <div className="font-bold text-gray-900 leading-tight flex-1 pr-2" style={{ fontSize: '15px' }}>
                                                        {node.title}
                                                    </div>
                                                    <span className={`px-2 py-1 rounded-lg text-xs font-bold whitespace-nowrap ${node.manual ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                                                        {node.manual ? 'MANUAL' : 'AUTO'}
                                                    </span>
                                                </div>
                                                <div className="text-xs text-gray-600 font-medium mb-2">{node.owner}</div>
                                                {node.severity === 'CRITICAL' && (
                                                    <div className="mt-2 px-2 py-1 bg-red-600 text-white text-xs font-black rounded-md">
                                                        🚨 CRITICAL
                                                    </div>
                                                )}
                                                {node.severity === 'HIGH' && (
                                                    <div className="mt-2 px-2 py-1 bg-orange-500 text-white text-xs font-bold rounded-md">
                                                        ⚠️ HIGH
                                                    </div>
                                                )}
                                            </div>
                                        </foreignObject>
                                    );
                                })}
                            </g>
                        </svg>

                        {/* Legend */}
                        <div className="no-print absolute bottom-6 left-6 bg-white rounded-2xl shadow-2xl p-5 border-2 border-gray-100">
                            <h3 className="font-black text-lg mb-3 text-gray-900">📊 Categories</h3>
                            {Object.entries(CATEGORIES).map(([cat, color]) => (
                                <div key={cat} className="flex items-center gap-3 mb-2">
                                    <div className="w-6 h-6 rounded-lg" style={{ background: color }}></div>
                                    <span className="font-semibold text-sm text-gray-700">{cat}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Detail Panel */}
                    {selectedNode && (
                        <div className="no-print fixed right-0 top-0 bottom-0 w-[500px] bg-white shadow-2xl overflow-y-auto z-50 detail-panel">
                            <div className="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 z-10">
                                <button
                                    onClick={() => { setSelectedNode(null); window.location.hash = ''; }}
                                    className="absolute top-6 right-6 w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-2xl font-bold transition-all"
                                >
                                    ×
                                </button>
                                <h2 className="text-2xl font-black mb-3 pr-12">{selectedNode.title}</h2>
                                <div className="flex gap-2 flex-wrap">
                                    <span className={`px-3 py-1.5 rounded-lg text-sm font-bold ${
                                        selectedNode.severity === 'CRITICAL' ? 'bg-red-500' :
                                        selectedNode.severity === 'HIGH' ? 'bg-orange-500' :
                                        selectedNode.severity === 'MEDIUM' ? 'bg-yellow-500' :
                                        'bg-green-500'
                                    }`}>
                                        {selectedNode.severity}
                                    </span>
                                    <span className={`px-3 py-1.5 rounded-lg text-sm font-bold ${selectedNode.manual ? 'bg-orange-400' : 'bg-green-400'}`}>
                                        {selectedNode.manual ? '👤 MANUAL' : '🤖 AUTO'}
                                    </span>
                                </div>
                            </div>

                            <div className="p-6 space-y-6">
                                <div>
                                    <h3 className="text-xs font-black uppercase tracking-wider text-gray-500 mb-2">👤 Owner</h3>
                                    <p className="text-base font-semibold text-gray-900">{selectedNode.owner}</p>
                                </div>

                                <div>
                                    <h3 className="text-xs font-black uppercase tracking-wider text-gray-500 mb-2">ℹ️ Context</h3>
                                    <p className="text-base leading-relaxed text-gray-700">{selectedNode.context}</p>
                                </div>

                                <div>
                                    <h3 className="text-xs font-black uppercase tracking-wider text-gray-500 mb-2">📥 Required Inputs</h3>
                                    <ul className="space-y-1.5">
                                        {selectedNode.inputs.map((inp, i) => (
                                            <li key={i} className="flex items-start gap-2 text-base text-gray-700">
                                                <span className="text-indigo-500 font-bold">→</span>
                                                <span>{inp}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>

                                <div>
                                    <h3 className="text-xs font-black uppercase tracking-wider text-gray-500 mb-2">📤 Downstream Effects</h3>
                                    <ul className="space-y-1.5">
                                        {selectedNode.downstream.map((ds, i) => (
                                            <li key={i} className="flex items-start gap-2 text-base text-gray-700">
                                                <span className="text-purple-500 font-bold">⇒</span>
                                                <span>{ds}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>

                                {selectedNode.gaps.length > 0 && (
                                    <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                                        <h3 className="text-sm font-black text-red-900 mb-2">⚠️ KNOWN GAPS</h3>
                                        <ul className="space-y-1.5">
                                            {selectedNode.gaps.map((gap, i) => (
                                                <li key={i} className="flex items-start gap-2 text-sm text-red-800">
                                                    <span>•</span>
                                                    <span>{gap}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {selectedNode.workarounds.length > 0 && (
                                    <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg">
                                        <h3 className="text-sm font-black text-yellow-900 mb-2">🔧 WORKAROUNDS</h3>
                                        <ul className="space-y-1.5">
                                            {selectedNode.workarounds.map((wa, i) => (
                                                <li key={i} className="flex items-start gap-2 text-sm text-yellow-800">
                                                    <span>•</span>
                                                    <span>{wa}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {idealState && selectedNode.ideal.length > 0 && (
                                    <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
                                        <h3 className="text-sm font-black text-green-900 mb-2">💡 IDEAL STATE</h3>
                                        <ul className="space-y-1.5">
                                            {selectedNode.ideal.map((ideal, i) => (
                                                <li key={i} className="flex items-start gap-2 text-sm text-green-800">
                                                    <span>•</span>
                                                    <span>{ideal}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FlowchartApp />);
    </script>
</body>
</html>
